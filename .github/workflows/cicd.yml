name: CI/CD - Backend MimaStore

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout do reposit√≥rio
      # -------------------------------------------------------------
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # 2Ô∏è‚É£ Configura√ß√£o do Java
      # -------------------------------------------------------------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # -------------------------------------------------------------
      # 3Ô∏è‚É£ Build do projeto
      # -------------------------------------------------------------
      - name: BE - Compilar projeto
        run: |
          echo "üèóÔ∏è Iniciando build do backend..."
          cd "Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mvn clean package -DskipTests
          echo "‚úÖ Build conclu√≠do com sucesso."

      # -------------------------------------------------------------
      # 3.5Ô∏è‚É£ Setup Python para consumers RabbitMQ
      # -------------------------------------------------------------
      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validar consumers Python (lint b√°sico)
        run: |
          echo "üîç Verificando sintaxe dos consumers Python..."
          python -m py_compile "Consumer - RabbitMQ/Envio de Comprovante/comprovante_venda_consumer.py"
          python -m py_compile "Consumer - RabbitMQ/Recupera√ß√£o de Senha/password_recovery_consumer_backup.py"
          echo "‚úÖ Consumers Python validados com sucesso!"

      # -------------------------------------------------------------
      # 4Ô∏è‚É£ Cria√ß√£o das chaves SSH tempor√°rias
      # -------------------------------------------------------------
      - name: Criar chaves SSH para Zona 1 e Zona 2
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY_AB }}" > ~/.ssh/private_key_ab.pem
          chmod 600 ~/.ssh/private_key_ab.pem
          echo "${{ secrets.EC2_SSH_KEY_CD }}" > ~/.ssh/private_key_cd.pem
          chmod 600 ~/.ssh/private_key_cd.pem
          ls -lah ~/.ssh

      # -------------------------------------------------------------
      # 5Ô∏è‚É£ Script remoto de deploy (criado no host destino)
      # -------------------------------------------------------------
      - name: Criar script de deploy para hosts privados
        run: |
          PROJETO_DIR="Sprint 4 - CleanArch/JavaSpringBoot/projetoMima"
          mkdir -p "$PROJETO_DIR"

          cat << 'EOF' > "$PROJETO_DIR/deploy_on_privado.sh"
          #!/bin/bash
          set -euo pipefail

          echo "üöÄ Iniciando deploy privado no host $(hostname)..."

          # Par√¢metros de configura√ß√£o (devem ser passados via vari√°veis de ambiente)
          RUN_DB=${RUN_DB:-false}          # true para subir MySQL, false para n√£o subir
          DB_HOST=${DB_HOST:-localhost}    # Host do banco (localhost ou IP privado da inst√¢ncia B)
          DB_USERNAME=${DB_USERNAME:-mimastore_user}
          DB_PASSWORD=${DB_PASSWORD:-12345}
          RABBITMQ_HOST=${RABBITMQ_HOST:-localhost} # Host do RabbitMQ

          echo "üìã Configura√ß√µes:"
          echo "  - RUN_DB: $RUN_DB"
          echo "  - DB_HOST: $DB_HOST"
          echo "  - DB_USERNAME: $DB_USERNAME"
          echo "  - RABBITMQ_HOST: $RABBITMQ_HOST"

          # ‚úÖ Corrige permiss√£o do Docker socket (caso travado)
          sudo chmod 666 /var/run/docker.sock || true

          PROJETO_DIR="$HOME/backend"
          DB_DIR="$PROJETO_DIR/Banco de Dados"
          BACKEND_DIR="$PROJETO_DIR/JavaSpringBoot/projetoMima"
          CONSUMER_COMPROVANTE_DIR="$HOME/backend/Consumer - RabbitMQ/Envio de Comprovante"
          CONSUMER_SENHA_DIR="$HOME/backend/Consumer - RabbitMQ/Recupera√ß√£o de Senha"

          COMPOSE_CMD=""
          if docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          elif command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          fi

          # Instala docker-compose se n√£o existir
          if [ -z "$COMPOSE_CMD" ]; then
            DOCKER_COMPOSE_VERSION=2.24.0
            sudo curl -SL "https://github.com/docker/compose/releases/download/v$DOCKER_COMPOSE_VERSION/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose || true
            COMPOSE_CMD="docker-compose"
          fi

          echo "üåê Verificando se a rede 'mima-network' existe..."
          if ! docker network ls --format '{{.Name}}' | grep -q '^mima-network$'; then
            echo "üß© Criando rede Docker: mima-network"
            sudo docker network create mima-network || true
          else
            echo "‚úÖ Rede 'mima-network' j√° existe."
          fi

          # Banco de dados e RabbitMQ (apenas se RUN_DB=true)
          if [ "$RUN_DB" = "true" ]; then
            echo "üóÑÔ∏è Subindo MySQL e RabbitMQ na inst√¢ncia privada B..."
            if [ -d "$DB_DIR" ]; then
              cd "$DB_DIR"
              sudo \$COMPOSE_CMD down -v || true
              sudo \$COMPOSE_CMD up -d --build
              echo "‚úÖ MySQL iniciado com sucesso"
              echo "‚è≥ Aguardando MySQL inicializar (30 segundos)..."
              sleep 30
            else
              echo "‚ö†Ô∏è Diret√≥rio do banco n√£o encontrado: $DB_DIR"
            fi
          else
            echo "‚è≠Ô∏è Pulando cria√ß√£o do banco e RabbitMQ (RUN_DB=false)"
            echo "üìç Backend conectar√° ao MySQL em: $DB_HOST:3306"
            echo "üìç Backend conectar√° ao RabbitMQ em: $RABBITMQ_HOST:5672"
          fi

          # Backend
          if [ -d "$BACKEND_DIR" ]; then
            echo "‚öôÔ∏è Subindo containers do Backend..."
            cd "$BACKEND_DIR"
            
            # Criar arquivo .env com configura√ß√µes do banco
            echo "üìù Criando arquivo .env com configura√ß√µes do banco..."
            echo "DB_HOST=\$DB_HOST" > .env
            echo "DB_USERNAME=\$DB_USERNAME" >> .env
            echo "DB_PASSWORD=\$DB_PASSWORD" >> .env
            echo "RABBITMQ_HOST=\$RABBITMQ_HOST" >> .env
            
            sudo \$COMPOSE_CMD down -v || true
            sudo \$COMPOSE_CMD up -d --build
            
            echo "‚è≥ Aguardando backend inicializar..."
            sleep 15
          fi

          # Consumer de Comprovantes
          if [ -d "$CONSUMER_COMPROVANTE_DIR" ]; then
            echo "üìß Subindo consumer de comprovantes..."
            cd "$CONSUMER_COMPROVANTE_DIR"
            sudo $COMPOSE_CMD down || true
            sudo $COMPOSE_CMD up -d --build
            echo "‚úÖ Consumer de comprovantes iniciado"
          else
            echo "‚ö†Ô∏è Diret√≥rio de consumer de comprovantes n√£o encontrado: $CONSUMER_COMPROVANTE_DIR"
          fi

          # Consumer de Recupera√ß√£o de Senha
          if [ -d "$CONSUMER_SENHA_DIR" ]; then
            echo "üîë Subindo consumer de recupera√ß√£o de senha..."
            cd "$CONSUMER_SENHA_DIR"
            sudo $COMPOSE_CMD -f docker-compose.consumer.yml down || true
            sudo $COMPOSE_CMD -f docker-compose.consumer.yml up -d --build
            echo "‚úÖ Consumer de recupera√ß√£o de senha iniciado"
          else
            echo "‚ö†Ô∏è Diret√≥rio de consumer de senha n√£o encontrado: $CONSUMER_SENHA_DIR"
          fi

          echo "‚úÖ Deploy finalizado com sucesso em $(hostname)"
          echo "üìä Containers em execu√ß√£o:"
          sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF

          chmod +x "$PROJETO_DIR/deploy_on_privado.sh"

      # -------------------------------------------------------------
      # 6Ô∏è‚É£ Deploy automatizado (verifica apenas hosts p√∫blicos)
      # -------------------------------------------------------------
      - name: BE - Deploy nos Hosts Privados (A‚ÜíB e C‚ÜíD)
        run: |
          set -euo pipefail

          HOST_A=${{ secrets.REMOTE_HOST }}
          HOST_B=${{ secrets.REMOTE_HOST_B }}
          HOST_C=${{ secrets.REMOTE_HOST_C }}
          HOST_D=${{ secrets.REMOTE_HOST_D }}
          USER=${{ secrets.REMOTE_USER }}

          KEY_AB=~/.ssh/private_key_ab.pem
          KEY_CD=~/.ssh/private_key_cd.pem

          # ---------------------------------------------------------
          # Fun√ß√µes com retry (SSH e RSYNC)
          # ---------------------------------------------------------
          retry_ssh() {
            local cmd="$1"
            local key="$2"
            local host="$3"
            local tries=3
            local delay=5
            local attempt=1
            until [ $attempt -gt $tries ]; do
              echo "üîÅ Tentativa $attempt de conex√£o com $host..."
              ssh -i "$key" -o ConnectTimeout=20 -o StrictHostKeyChecking=no $USER@$host "$cmd" && return 0
              echo "‚ö†Ô∏è Falha, tentando novamente em $delay segundos..."
              sleep $delay
              attempt=$((attempt+1))
              delay=$((delay*2))
            done
            echo "‚ùå Falha ao conectar em $host ap√≥s $tries tentativas."
            return 1
          }

          retry_rsync() {
            local src="$1"
            local dest="$2"
            local key="$3"
            local tries=3
            local delay=5
            local attempt=1
            until [ $attempt -gt $tries ]; do
              echo "üì¶ Enviando arquivos (tentativa $attempt)..."
              rsync -avz --partial --timeout=60 \
                -e "ssh -i $key -o StrictHostKeyChecking=no -o ServerAliveInterval=30" \
                "$src" "$dest" && return 0
              echo "‚ö†Ô∏è Falha no rsync, tentando novamente em $delay segundos..."
              sleep $delay
              attempt=$((attempt+1))
              delay=$((delay*2))
            done
            echo "‚ùå Falha no rsync ap√≥s $tries tentativas."
            return 1
          }

          # ---------------------------------------------------------
          # üß≠ Deploy - Zona 1 (A ‚Üí B)
          # ---------------------------------------------------------
          echo "üåç Iniciando deploy na Zona 1 (A ‚Üí B)..."

          echo "üîé Testando acesso SSH ao host p√∫blico A..."
          if ! ssh -i "$KEY_AB" -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no $USER@$HOST_A "echo ok" >/dev/null 2>&1; then
            echo "‚ùå Host p√∫blico A ($HOST_A) inacess√≠vel via SSH!"
            exit 1
          fi

          retry_rsync "Sprint 4 - CleanArch/" "$USER@$HOST_A:/home/$USER/backend_temp_deploy" "$KEY_AB"
          retry_rsync "Consumer - RabbitMQ/" "$USER@$HOST_A:/home/$USER/backend_temp_deploy/Consumer - RabbitMQ" "$KEY_AB"
          retry_rsync "Sprint 4 - CleanArch/nginx/" "$USER@$HOST_A:/home/$USER/backend_temp_deploy/nginx" "$KEY_AB"
          retry_ssh "echo '${{ secrets.EC2_SSH_KEY_AB }}' > ~/private_key.pem && chmod 600 ~/private_key.pem" "$KEY_AB" "$HOST_A"

          echo "üîÅ Replicando c√≥digo de A ‚Üí Privado B - COM MySQL e RabbitMQ..."
          retry_ssh "
            rsync -avz --partial --timeout=60 \
              -e 'ssh -i ~/private_key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30' \
              /home/$USER/backend_temp_deploy/ $USER@$HOST_B:/home/$USER/backend
          " "$KEY_AB" "$HOST_A"

          echo "‚öôÔ∏è Executando script de deploy no Privado B - COM MySQL + RabbitMQ..."
          retry_ssh "ssh -i ~/private_key.pem -o StrictHostKeyChecking=no $USER@$HOST_B 'RUN_DB=true DB_HOST=localhost DB_USERNAME=mimastore_user DB_PASSWORD=12345 bash /home/$USER/backend/JavaSpringBoot/projetoMima/deploy_on_privado.sh'" "$KEY_AB" "$HOST_A"

          # ---------------------------------------------------------
          # üß≠ Deploy - Zona 2 (C ‚Üí D)
          # ---------------------------------------------------------
          echo "üåç Iniciando deploy na Zona 2 (C ‚Üí D)..."

          echo "üîé Testando acesso SSH ao host p√∫blico C..."
          if ! ssh -i "$KEY_CD" -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no $USER@$HOST_C "echo ok" >/dev/null 2>&1; then
            echo "‚ùå Host p√∫blico C ($HOST_C) inacess√≠vel via SSH!"
            exit 1
          fi

          retry_rsync "Sprint 4 - CleanArch/" "$USER@$HOST_C:/home/$USER/backend_temp_deploy" "$KEY_CD"
          retry_rsync "Consumer - RabbitMQ/" "$USER@$HOST_C:/home/$USER/backend_temp_deploy/Consumer - RabbitMQ" "$KEY_CD"
          retry_rsync "Sprint 4 - CleanArch/nginx/" "$USER@$HOST_C:/home/$USER/backend_temp_deploy/nginx" "$KEY_CD"
          retry_ssh "echo '${{ secrets.EC2_SSH_KEY_CD }}' > ~/private_key.pem && chmod 600 ~/private_key.pem" "$KEY_CD" "$HOST_C"

          echo "üîÅ Replicando c√≥digo de C ‚Üí Privado D - SEM banco, aponta para B..."
          retry_ssh "
            rsync -avz --partial --timeout=60 \
              -e 'ssh -i ~/private_key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30' \
              /home/$USER/backend_temp_deploy/ $USER@$HOST_D:/home/$USER/backend
          " "$KEY_CD" "$HOST_C"

          echo "‚öôÔ∏è Executando script de deploy no Privado D - SEM MySQL/RabbitMQ, conecta √† Privada B..."
          retry_ssh "ssh -i ~/private_key.pem -o StrictHostKeyChecking=no $USER@$HOST_D 'RUN_DB=false DB_HOST=${{ secrets.REMOTE_HOST_PRIVADO_B }} RABBITMQ_HOST=${{ secrets.REMOTE_HOST_PRIVADO_B }} DB_USERNAME=mimastore_user DB_PASSWORD=12345 bash /home/$USER/backend/JavaSpringBoot/projetoMima/deploy_on_privado.sh'" "$KEY_CD" "$HOST_C"

          echo "‚úÖ Deploy finalizado com sucesso em todas as zonas!"
